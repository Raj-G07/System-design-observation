# üßæ Coupon System Design
## üéØ Objective

Design a flexible, extensible, and thread-safe coupon management system that supports various coupon types, discount rules, and runtime coupon registration.

The system should handle cart-level and product-level discounts, flat and percentage-based reductions, and allow or restrict stacking of multiple coupons depending on business logic.

---

## ‚öôÔ∏è Functional Requirements

**1.Dynamic Coupon Addition** ‚Äì New coupons can be registered at runtime without restarting the system.

**2.Multiple Coupon Types Supported**

- Seasonal Offers
- Loyalty Discounts
- Banking Discounts
- Product-Level Discounts
- Cart-Level Discounts

**3.Supports Flat and Percentage Discounts** ‚Äì Discounts can either be a fixed amount or a percentage of the total.

**4.Stackable Control** ‚Äì Some coupons can be applied together, while others cannot.

**5.Thread Safety** ‚Äì The coupon registry must handle concurrent coupon registrations and lookups safely.

**6.Extensible Design** ‚Äì New coupon types or rules can be added easily by extending the base coupon interface.

---

## üß© Core Components
**1. CouponManager**

- Acts as the main controller for applying coupons to a cart.
- Fetches coupons from the registry and validates stackability and applicability.
- Ensures the correct order of coupon application.
- Handles final price computation after all applicable discounts.

**Responsibilities:**

- Manage coupon application flow.
- Enforce stacking rules.
- Compute final cart amount after discounts.

**2. Coupon (Interface)**

Defines a common structure for all types of coupons, ensuring new coupon types can be added without modifying existing logic (Open/Closed Principle).

**Key Methods:**

`isApplicable(Cart)` ‚Üí Checks if coupon conditions are met.

`applyDiscount(Cart)` ‚Üí Applies discount logic.

`isStackable()` ‚Üí Determines if it can be combined with others.

**Attributes:**

`id` ‚Äì Unique identifier for the coupon.

`type` ‚Äì Type of the coupon (Seasonal, Loyalty, etc.).

`stackable` ‚Äì Whether the coupon can be used with others.

**3. CouponType (Enumeration)**

Represents the classification of coupons for easy filtering and management.

**Values:**

- `SEASONAL`

- `LOYALTY`

- `BANKING`

- `PRODUCT_LEVEL`

- `CART_LEVEL`

**4. Concrete Coupon Classes**
**üü¢ FlatDiscountCoupon**

- Applies a fixed discount (e.g., ‚Çπ100 off).
- Used for cart-level offers or fixed-value promotions.

**üîµ PercentageDiscountCoupon**

- Applies a percentage-based discount (e.g., 10% off).
- Useful for seasonal or banking offers.

**5. Cart**

Represents the user's shopping cart containing multiple products.
Provides methods to compute total value and apply discounts.

**Attributes:**

- `products` ‚Äì List of products.
- `totalAmount` ‚Äì Running total after discount application.

**Responsibilities:**

- Maintain cart total.
- Apply given discount.
- Expose product list for product-level coupons.

**6. Product**

Represents an individual item in the cart.

**Attributes:**

- `id`, `name`, `price`, `quantity`

**Responsibilities:**

- Provide pricing data for discount calculations.

**7. ThreadSafeCouponRegistry**

A concurrent-safe registry to manage coupons dynamically at runtime.

**Responsibilities:**

- Register new coupons (`registerCoupon`)
- Retrieve coupons (`getCoupon`)
- Remove coupons (`removeCoupon`)
- Ensure thread safety via mutex locks

**Design Note:**
This allows administrators or systems to add new coupons while the system is live ‚Äî enabling runtime configurability.

---

## üß† Design Principles Used

- **Open/Closed Principle** ‚Üí New coupons can be added without modifying existing code.
- **Single Responsibility Principle** ‚Üí Each class handles one concern (e.g., `CouponManager` applies coupons, `Registry` manages storage).
- **Thread Safety** ‚Üí Mutex locking in `ThreadSafeCouponRegistry` ensures safe concurrent access.
- **Extensibility** ‚Üí Base `Coupon` interface supports future coupon types (e.g., category-based, referral-based, etc.).

---

## UML Class Diagram
!!! note ""
    ```mermaid
    classDiagram
        class CouponManager {
            - List<Coupon> coupons
            + addCoupon(Coupon) 
            + removeCoupon(String couponId)
            + getApplicableCoupons(Cart): List<Coupon>
            + applyCoupons(Cart): void
            + isStackable(Coupon, Coupon): bool
        }
    
        class Coupon {
            <<interface>>
            + getId(): String
            + getType(): CouponType
            + isApplicable(Cart): bool
            + applyDiscount(Cart): void
            + isStackable(): bool
        }
    
        class CouponType {
            <<enumeration>>
            SEASONAL
            LOYALTY
            BANKING
            PRODUCT_LEVEL
            CART_LEVEL
        }
    
        class FlatDiscountCoupon {
            - double flatAmount
            + applyDiscount(Cart): void
        }
    
        class PercentageDiscountCoupon {
            - double percent
            + applyDiscount(Cart): void
        }
    
        class Cart {
            - List<Product> products
            - double totalAmount
            + getTotal(): double
            + applyDiscount(double): void
        }
    
        class Product {
            - String id
            - String name
            - double price
            - int quantity
        }
    
        class ThreadSafeCouponRegistry {
            - static Map<String, Coupon> registry
            + registerCoupon(Coupon): void
            + getCoupon(String id): Coupon
            + removeCoupon(String id): void
            <<thread-safe>>
        }
    
        CouponManager --> Coupon
        Coupon <|.. FlatDiscountCoupon
        Coupon <|.. PercentageDiscountCoupon
        CouponManager --> Cart
        Cart --> Product
        Coupon --> CouponType
        CouponManager --> ThreadSafeCouponRegistry
    ```

---

## C++ Implementation
```cpp title="coupon-system.cpp" linenums="1"
#include <iostream>
#include <vector>
#include <unordered_map>
#include <memory>
#include <mutex>
#include <string>
using namespace std;

//----------------------------------------------
// ENUM: CouponType
//----------------------------------------------
enum class CouponType {
    SEASONAL,
    LOYALTY,
    BANKING,
    PRODUCT_LEVEL,
    CART_LEVEL
};

//----------------------------------------------
// PRODUCT CLASS
//----------------------------------------------
class Product {
public:
    string id;
    string name;
    double price;
    int quantity;

    Product(string id, string name, double price, int quantity)
        : id(id), name(name), price(price), quantity(quantity) {}
};

//----------------------------------------------
// CART CLASS
//----------------------------------------------
class Cart {
    vector<Product> products;
    double totalAmount = 0.0;

public:
    void addProduct(const Product& p) {
        products.push_back(p);
        totalAmount += p.price * p.quantity;
    }

    double getTotal() const { return totalAmount; }

    void applyDiscount(double discount) {
        totalAmount -= discount;
        if (totalAmount < 0) totalAmount = 0;
    }

    const vector<Product>& getProducts() const { return products; }
};

//----------------------------------------------
// COUPON INTERFACE (Base Class)
//----------------------------------------------
class Coupon {
protected:
    string id;
    CouponType type;
    bool stackable;

public:
    Coupon(string id, CouponType type, bool stackable)
        : id(id), type(type), stackable(stackable) {}

    virtual ~Coupon() = default;

    string getId() const { return id; }
    CouponType getType() const { return type; }
    bool isStackable() const { return stackable; }

    virtual bool isApplicable(const Cart& cart) const = 0;
    virtual void applyDiscount(Cart& cart) const = 0;
};

//----------------------------------------------
// FLAT DISCOUNT COUPON
//----------------------------------------------
class FlatDiscountCoupon : public Coupon {
    double flatAmount;

public:
    FlatDiscountCoupon(string id, CouponType type, bool stackable, double amount)
        : Coupon(id, type, stackable), flatAmount(amount) {}

    bool isApplicable(const Cart& cart) const override {
        return cart.getTotal() > flatAmount;
    }

    void applyDiscount(Cart& cart) const override {
        cout << "Applying Flat Discount: ‚Çπ" << flatAmount << endl;
        cart.applyDiscount(flatAmount);
    }
};

//----------------------------------------------
// PERCENTAGE DISCOUNT COUPON
//----------------------------------------------
class PercentageDiscountCoupon : public Coupon {
    double percent;

public:
    PercentageDiscountCoupon(string id, CouponType type, bool stackable, double percent)
        : Coupon(id, type, stackable), percent(percent) {}

    bool isApplicable(const Cart& cart) const override {
        return cart.getTotal() > 0;
    }

    void applyDiscount(Cart& cart) const override {
        double discount = cart.getTotal() * (percent / 100.0);
        cout << "Applying " << percent << "% Discount: ‚Çπ" << discount << endl;
        cart.applyDiscount(discount);
    }
};

//----------------------------------------------
// THREAD-SAFE COUPON REGISTRY
//----------------------------------------------
class ThreadSafeCouponRegistry {
    unordered_map<string, shared_ptr<Coupon>> registry;
    mutable mutex mtx;

public:
    void registerCoupon(shared_ptr<Coupon> coupon) {
        lock_guard<mutex> lock(mtx);
        registry[coupon->getId()] = coupon;
    }

    shared_ptr<Coupon> getCoupon(const string& id) const {
        lock_guard<mutex> lock(mtx);
        auto it = registry.find(id);
        if (it != registry.end()) return it->second;
        return nullptr;
    }

    void removeCoupon(const string& id) {
        lock_guard<mutex> lock(mtx);
        registry.erase(id);
    }
};

//----------------------------------------------
// COUPON MANAGER
//----------------------------------------------
class CouponManager {
    ThreadSafeCouponRegistry& registry;

public:
    CouponManager(ThreadSafeCouponRegistry& reg) : registry(reg) {}

    void applyCoupons(Cart& cart, const vector<string>& couponIds) {
        double before = cart.getTotal();
        cout << "\nInitial Cart Total: ‚Çπ" << before << endl;

        shared_ptr<Coupon> lastApplied = nullptr;

        for (const string& id : couponIds) {
            auto coupon = registry.getCoupon(id);
            if (!coupon) {
                cout << "Coupon " << id << " not found.\n";
                continue;
            }

            if (lastApplied && !lastApplied->isStackable() && !coupon->isStackable()) {
                cout << "Coupon " << id << " cannot be stacked on top of another.\n";
                continue;
            }

            if (coupon->isApplicable(cart)) {
                coupon->applyDiscount(cart);
                lastApplied = coupon;
            } else {
                cout << "Coupon " << id << " not applicable.\n";
            }
        }

        cout << "Final Cart Total: ‚Çπ" << cart.getTotal() << endl;
    }
};

//----------------------------------------------
// MAIN (DEMO)
//----------------------------------------------
int main() {
    ThreadSafeCouponRegistry registry;

    registry.registerCoupon(make_shared<FlatDiscountCoupon>(
        "FLAT100", CouponType::SEASONAL, true, 100));
    registry.registerCoupon(make_shared<PercentageDiscountCoupon>(
        "BANK10", CouponType::BANKING, false, 10));

    Cart cart;
    cart.addProduct(Product("P1", "Laptop", 50000, 1));
    cart.addProduct(Product("P2", "Mouse", 1000, 2));

    CouponManager manager(registry);
    manager.applyCoupons(cart, {"FLAT100", "BANK10"});

    return 0;
}
```

---

## üöÄ Future Enhancements

- **Product-Level Filtering**: Apply specific coupons only to targeted product IDs or categories.
- **Coupon Expiration & Validity**: Add expiry dates, usage limits, or minimum purchase conditions.
- **User-Specific Coupons**: Link coupons to loyalty profiles or user IDs.
- **Logging & Monitoring**: Track coupon usage analytics and failures.
- **API Integration**: Expose REST endpoints for adding or applying coupons dynamically.

---

## ‚úÖ Summary

!!! details ""
    | Component                  | Responsibility                        | Extensible | Thread-Safe |
    | -------------------------- | ------------------------------------- | ---------- | ----------- |
    | `CouponManager`            | Controls application logic            | ‚úÖ          | ‚öôÔ∏è          |
    | `Coupon` Interface         | Defines contract for all coupon types | ‚úÖ          | ‚Äî           |
    | `FlatDiscountCoupon`       | Implements fixed discount logic       | ‚úÖ          | ‚Äî           |
    | `PercentageDiscountCoupon` | Implements percentage discount logic  | ‚úÖ          | ‚Äî           |
    | `ThreadSafeCouponRegistry` | Manages coupons concurrently          | ‚úÖ          | ‚úÖ           |
    | `Cart`                     | Holds cart data and applies discounts | ‚úÖ          | ‚Äî           |
    